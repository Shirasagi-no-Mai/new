import openpyxl
from openpyxl import Workbook
from selenium.common.exceptions import ElementNotInteractableException
from openpyxl.styles import PatternFill
import re
import sys
from bs4 import BeautifulSoup

import tkinter as tk
import inspect
import pandas as pd
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from selenium.webdriver.common.action_chains import ActionChains
from datetime import datetime
import os
import time
from selenium.common.exceptions import NoAlertPresentException
from selenium.webdriver.support.ui import Select
from selenium.common.exceptions import StaleElementReferenceException
from tkinter import Toplevel
from tkinter import ttk
import requests
from collections import Counter
import shutil
import glob
from seleniumwire.utils import decode
import requests
import json
import base64
import zlib
import gzip
import subprocess
from requests.exceptions import ConnectionError, Timeout, RequestException
import traceback
from openpyxl import load_workbook
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from requests.exceptions import ConnectionError, Timeout, RequestException
import msoffcrypto
import string
import re
import numpy as np  # å¯¼å…¥numpyä»¥æ£€æŸ¥NaNå’ŒInfå€¼

# *************************é€šè¿‡ä¸ªäººç½‘é¡µæ›´æ–°è¿‡æœŸæ—¥æœŸ*************************************************************************
CONFIG_URL = "https://raw.githubusercontent.com/Shirasagi-no-Mai/my-exe-control/main/expiration_config.json"


def fetch_expiration_date():
    try:
        response = requests.get(CONFIG_URL)
        response.raise_for_status()
        config = json.loads(response.text)
        return datetime.strptime(config['expiration_date'], '%Y-%m-%d')
    except requests.exceptions.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")

        return None
    except (json.JSONDecodeError, KeyError, ValueError) as e:
        print(f"è§£æé”™è¯¯: {e}")
        return None


expiration_date1 = fetch_expiration_date()
print(f"expiration_date1: {expiration_date1}")

# â‘¡ åŠŸèƒ½æƒé™é…ç½®
# ----------------------------
PERMISSION_URL = "https://raw.githubusercontent.com/Shirasagi-no-Mai/my-exe-control2/refs/heads/main/onlinecode"


def fetch_permissions():
    """ä»è¿œç¨‹è¯»å–åŠŸèƒ½æƒé™åˆ—è¡¨"""
    try:
        response = requests.get(PERMISSION_URL, timeout=10)
        response.raise_for_status()
        data = response.json()
        permissions = {f["name"]: f["allowed_users"] for f in data.get("functions", [])}
        return permissions
    except requests.exceptions.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
    except (json.JSONDecodeError, KeyError, ValueError) as e:
        print(f"è§£æé”™è¯¯: {e}")
    return {}


permissions = fetch_permissions()


def is_user_allowed(func_name, username):
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡ŒæŸå‡½æ•°"""
    return username in permissions.get(func_name, [])


# ----------------------------
# âœ… ç¤ºä¾‹æ‰§è¡Œ
# ----------------------------


permissions = fetch_permissions()
print("æƒé™åˆ—è¡¨ç¤ºä¾‹ï¼š")
print(json.dumps(permissions, indent=2, ensure_ascii=False))

# *************************é€šè¿‡ä¸ªäººç½‘é¡µæ›´æ–°è¿‡æœŸæ—¥æœŸ*************************************************************************


# *************************é¢„è®¾*****************************************************************************************

# æ›´æ–°è¾“å‡ºæ–‡æœ¬æ¡†
windowname = ""
from selenium.common.exceptions import UnexpectedAlertPresentException, ElementClickInterceptedException


def update_output_text(output_text, message):
    output_text.insert(tk.END, message)
    output_text.yview(tk.END)


# *************************é¢„è®¾*****************************************************************************************
def netchb_token(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()
    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)


    if desktop_path:
        txt_file_path = os.path.join(desktop_path, "yuejie.txt")
        if os.path.exists(txt_file_path):
            update_output_text(output_text, "å·²æ‰¾åˆ°output.txtï¼Œæ­£åœ¨è¿è¡Œ\n")
            pass
        else:
            update_output_text(output_text, "å·²åˆ›å»ºéœ€è¦çš„æ–‡ä»¶ éœ€è¦å†æ¬¡ç‚¹å‡»å¼€å§‹\n")
            with open(txt_file_path, 'w', encoding='utf-8'):
                pass
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text,"åˆ›å»ºexcelå¤±è´¥")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://www.netchb.com/app/entry/"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])

    account = account
    password =password
    # # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="lName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="pass"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.XPATH,
                                       "/html/body/div[2]/div[3]/div/main/div/div/div/article/div/div/form/div[2]/input")
    login_button.click()
    initial_title = driver.title
    initial_url = driver.current_url
    url = "https://www.netchb.com/app/entry/"
    driver.get(url)

    def page_changed(t, u):
        def _pred(d): return d.title != t or d.current_url != u

        return _pred

    try:
        WebDriverWait(driver, 50).until(page_changed(initial_title, initial_url))
    except Exception as e:
        raise

    def get_cookies_from_driver(driver):
        """
        ä» Selenium driver è·å– cookiesï¼Œå¹¶è½¬æ¢ä¸º requests.Session èƒ½æ­£ç¡®ä½¿ç”¨çš„æ ¼å¼
        ä¿ç•™ domain, path, secure, expiry ç­‰å…³é”®å±æ€§
        """
        try:
            selenium_cookies = driver.get_cookies()
            requests_cookies = {}


            for cookie in selenium_cookies:
                name = cookie['name']
                value = cookie['value']
                domain = cookie.get('domain', '')
                path = cookie.get('path', '/')
                secure = cookie.get('secure', False)
                expiry = cookie.get('expiry')  # å¯é€‰ï¼Œrequests ä¼šè‡ªåŠ¨å¤„ç†

                # å…³é”®ï¼šä½¿ç”¨ requests çš„ cookiejar æœºåˆ¶æ­£ç¡®è®¾ç½®
                # æ³¨æ„ï¼šæˆ‘ä»¬ä¸èƒ½ç›´æ¥ç”¨ dictï¼Œrequests éœ€è¦ç”¨ .set()
                # æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿”å›ä¸€ä¸ª listï¼Œåé¢ç”¨ session.cookies.set()
                requests_cookies[name] = {
                    'value': value,
                    'domain': domain,
                    'path': path,
                    'secure': secure,
                    'expiry': expiry
                }



            return requests_cookies  # è¿”å›ç»“æ„åŒ–å­—å…¸

        except Exception as e:
            print(f"[Error] è·å– cookies å¤±è´¥: {e}")
            traceback.print_exc()
            return {}

    if desktop_path:
        txt_file_path = os.path.join(desktop_path, "yuejie.txt")
        if not os.path.exists(txt_file_path):
            update_output_text(output_text,"æœªæ‰¾åˆ°output.txt\n")
            pass
        else:
            cookies_dict = get_cookies_from_driver(driver)
            with open(txt_file_path, 'w', encoding='utf-8') as txt_file:
                txt_file.write(json.dumps({"cookies": cookies_dict}, ensure_ascii=False))
            driver.quit()
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        driver.quit()
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    update_output_text(output_text, "èº«ä»½ä¿¡æ¯è·å–å®Œæˆ")
    driver.quit()
def netchb_query(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()


    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "yuejie.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text,"å·²æ‰¾åˆ°ç”¨äºè¾“å‡ºçš„excelæ–‡ä»¶å³å°†ç»§ç»­ä»£ç \n\n")
            # ç»§ç»­åç»­ä»£ç ...
        else:
            update_output_text(output_text,"æœªæ‰¾åˆ°ç”¨äºè¾“å‡ºçš„excelæ–‡ä»¶ï¼Œæ­£åœ¨ç”Ÿæˆç©ºçš„\n\n")

            # åˆ›å»ºä¸€ä¸ªå¸¦è¡¨å¤´çš„ç©º Excel æ–‡ä»¶ï¼ˆå¯æ‰“å¼€ã€å¯ç¼–è¾‘ï¼‰
            empty_df = pd.DataFrame(columns=["Entry No"])  # å¯æ ¹æ®éœ€è¦ä¿®æ”¹åˆ—å
            empty_df.to_excel(file_path, index=False, engine='openpyxl')

            update_output_text(output_text,f"å·²æˆåŠŸç”Ÿæˆï¼š{file_path}\nè¯·æ‰“å¼€æ–‡ä»¶å¡«å…¥æ•°æ®åï¼Œé‡æ–°è¿è¡Œç¨‹åºã€‚\n\n")
            sys.exit()  # ç¨‹åºåœæ­¢ï¼Œç­‰å¾…ç”¨æˆ·å¡«æ•°æ®

    def read_cookies_from_txt():
        txt_file_path = os.path.join(desktop_path, "yuejie.txt")

        if not os.path.exists(txt_file_path):
            update_output_text(output_text,"output.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼\n")
            return {}

        try:
            with open(txt_file_path, 'r', encoding='utf-8') as txt_file:
                data = json.load(txt_file)

            raw_cookies = data.get("cookies", {})
            if not isinstance(raw_cookies, dict):
                update_output_text(output_text,"å¼‚å¸¸1")
                return {}

            cookies_dict = {}
            for name, info in raw_cookies.items():
                if isinstance(info, dict) and 'value' in info:
                    cookies_dict[name] = info['value']
                else:
                    cookies_dict[name] = str(info)

            return cookies_dict

        except json.JSONDecodeError as je:
            update_output_text(output_text,f"ç½‘é¡µè§£æå¤±è´¥ï¼é”™è¯¯: {je}")
            return {}
        except Exception as e:
            update_output_text(output_text,f"è¯»å–æ–‡æœ¬æ–‡ä»¶å‡ºé”™: {type(e).__name__}: {e}")
            return {}

    def get_mawb_info(entry_no, cookies):
        cookies_dict = cookies
        if not cookies_dict:
            return {"error": "å¼‚å¸¸2"}

        session = requests.Session()
        for name, value in cookies_dict.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")

        # Step 1: è®¿é—®èœå•é¡µä¿æŒä¼šè¯
        session.get("https://www.netchb.com/app/entry/entryMenu.do?checkResponse=true", verify=False)

        # Step 2: POST æŸ¥è¯¢
        payload = {
            "filerCode": "NXU",
            "entryNo": entry_no
        }

        headers = {
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
            "Accept-Encoding": "gzip, deflate, br, zstd",
            "Accept-Language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7",
            "Connection": "keep-alive",
            "Host": "www.netchb.com",
            "Referer": f"https://www.netchb.com/app/entry/viewEntry.do?filerCode=NXU&entryNo={entry_no}",
            "Sec-Ch-Ua": '"Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"',
            "Sec-Ch-Ua-Mobile": "?0",
            "Sec-Ch-Ua-Platform": '"Windows"',
            "Sec-Fetch-Dest": "document",
            "Sec-Fetch-Mode": "navigate",
            "Sec-Fetch-Site": "same-origin",
            "Sec-Fetch-User": "?1",
            "Upgrade-Insecure-Requests": "1",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36",
            "Content-Type": "application/x-www-form-urlencoded"
        }

        try:
            resp = session.post(
                url="https://www.netchb.com/app/entry/transmit/finalizeEntry.do",
                data=payload,
                headers=headers,
                timeout=30,
                verify=False
            )
        except Exception as e:
            update_output_text(output_text,"ä¸»å•ä¿¡æ¯è¯·æ±‚å¤±è´¥:", e)
            return {k: "N/A" for k in [
                "entryActionCode", "viaAce", "cargoReleaseViaAce",
                "cargoReleaseActionCode", "arrivalDate", "inBondType", "saBtaAction"
            ]}

        if resp.status_code != 200 or "login" in resp.text.lower():
            update_output_text(output_text,"å¼‚å¸¸3")
            return {k: "N/A" for k in [
                "entryActionCode", "viaAce", "cargoReleaseViaAce",
                "cargoReleaseActionCode", "arrivalDate", "inBondType", "saBtaAction"
            ]}

        # ====================== 3. è§£æ HTML ======================
        soup = BeautifulSoup(resp.text, 'html.parser')

        result = {
            "entryActionCode": "N/A",
            "viaAce": "N/A",
            "cargoReleaseViaAce": "N/A",
            "cargoReleaseActionCode": "N/A",
            "arrivalDate": "N/A",
            "inBondType": "N/A",
            "saBtaAction": "N/A"
        }

        # 1. entryActionCode
        eac = soup.find("select", {"name": "entryActionCode"})
        if eac:
            selected = eac.find("option", selected=True)
            result["entryActionCode"] = selected["value"] if selected else "N/A"

        # 2. viaAce (checkbox)
        via_ace = soup.find("input", {"name": "viaAce"})
        if via_ace and via_ace.get("checked") is not None:
            result["viaAce"] = via_ace.get("value", "true")

        # 3. cargoReleaseViaAce
        crva = soup.find("input", {"name": "cargoReleaseViaAce"})
        if crva and crva.get("checked") is not None:
            result["cargoReleaseViaAce"] = crva.get("value", "true")

        # 4. cargoReleaseActionCode
        crar = soup.find("select", {"name": "cargoReleaseActionCode"})
        if crar:
            selected = crar.find("option", selected=True)
            result["cargoReleaseActionCode"] = selected["value"] if selected else "N/A"

        # 5. arrivalDate
        ar_d = soup.find("input", {"name": "arrivalDate"})
        if ar_d and ar_d.get("value"):
            result["arrivalDate"] = ar_d["value"]

        # 6. inBondType â€”â€” ä¿®å¤ï¼šå³ä½¿æ²¡æœ‰ selectedï¼Œä¹Ÿå–ç¬¬ä¸€ä¸ª option
        ibt = soup.find("select", {"name": "inBondType"})
        if ibt:
            selected = ibt.find("option", selected=True)
            if selected:
                result["inBondType"] = selected["value"]
            else:
                first_opt = ibt.find("option")
                result["inBondType"] = first_opt["value"] if first_opt else "N/A"
        else:
            result["inBondType"] = "N/A"

        # 7. saBtaAction â€”â€” ä¿®å¤ï¼šåŒä¸Š
        sabac = soup.find("select", {"name": "saBtaAction"})
        if sabac:
            selected = sabac.find("option", selected=True)
            if selected:
                result["saBtaAction"] = selected["value"]
            else:
                first_opt = sabac.find("option")
                result["saBtaAction"] = first_opt["value"] if first_opt else "N/A"
        else:
            result["saBtaAction"] = "N/A"

        # ====================== 4. è¾“å‡ºç»“æœ ======================


        return result

    def creat_entry_query(entry_no, mawb_info):
        result = mawb_info
        if "error" in result:
            update_output_text(output_text,f"å¼‚å¸¸4: {result['error']}ï¼Œåœæ­¢æ„å»º")
            return None
        payload = {
            "entryActionCode": result.get("entryActionCode", ""),
            "viaAce": result.get("viaAce", ""),
            "cargoReleaseViaAce": result.get("cargoReleaseViaAce", ""),
            "cargoReleaseActionCode": result.get("cargoReleaseActionCode", ""),
            "disNumber": "",
            "results": "true",
            "arrivalDate": result.get("arrivalDate", ""),
            "actionCode": "",
            "inBondType": result.get("inBondType", ""),
            "saBtaAction": result.get("saBtaAction", ""),
            "ogaCode": "",
            "method": "cargoManifestQuery",
            "cmqQueryBy": "bol",
            "extensionClosure": "",
            "filerCode": "NXU",
            "entryNo": entry_no
        }

        from urllib.parse import urlencode
        return urlencode(payload)

    def transmit_entry_request(entry_no, payload_information_query):
        cookies_dict = read_cookies_from_txt()
        if not cookies_dict:
            update_output_text(output_text,"å¼‚å¸¸5")
            return None

        payload_str = payload_information_query
        if payload_str is None:  # å¤±è´¥è¿”å› None
            update_output_text(output_text,"å¼‚å¸¸6")
            return None
        session = requests.Session()
        for name, value in cookies_dict.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")

        # ç”Ÿæˆ payload å­—ç¬¦ä¸²

        headers = {
            "Connection": "keep-alive",
            "Content-Type": "application/x-www-form-urlencoded",  # æ­£ç¡®ï¼
            "Referer": f"https://www.netchb.com/app/entry/viewEntry.do?filerCode=NXU&entryNo={entry_no}",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
            "Accept": "*/*",
            "Accept-Encoding": "gzip, deflate, br",
            "Accept-Language": "zh-CN,zh;q=0.9"
        }

        url = "https://www.netchb.com/app/entry/transmit/transmitEntry.do"

        try:
            response = session.post(
                url=url,
                data=payload_str,  # ç›´æ¥ä¼  urlencoded å­—ç¬¦ä¸²
                headers=headers,
                timeout=30,
                verify=False,
                allow_redirects=False  # ä¿ç•™ 302 åŸå§‹å“åº”
            )



            return session, response

        except Exception as e:
            update_output_text(output_text,f"å¼‚å¸¸10: {e}")
            return None, None

    def get_query_number(entry_no, query_result):

        cookies_dict = read_cookies_from_txt()
        if not cookies_dict:
            update_output_text(output_text,"å¼‚å¸¸11")
            return None

        result = query_result
        if not result:
            update_output_text(output_text,"å¼‚å¸¸12")
            return None
        session, transmit_resp = result  # è§£åŒ…

        for name, value in cookies_dict.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")

        headers = {
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "Pragma": "no-cache",
            "Expires": "Wed, 31 Dec 1969 19:00:00 EST",
            "Referer": f"https://www.netchb.com/app/entry/viewEntry.do?filerCode=NXU&entryNo={entry_no}",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Encoding": "gzip, deflate, br",
            "Accept-Language": "zh-CN,zh;q=0.9"
        }

        url = "https://www.netchb.com/app/entry/entryMenu.do"
        payload = {"checkResponse": ""}

        try:
            response = session.post(
                url=url,
                data=payload,
                headers=headers,
                timeout=30,
                verify=False
            )



            # å°è¯• JSONï¼ˆå¤‡ç”¨ï¼‰
            try:
                json_data = response.json()
                return json_data
            except:
                pass  # ä¸æ˜¯ JSONï¼Œç»§ç»­è§£æ HTML

            # è§£æ HTMLï¼Œæ‰¾ç¬¬ä¸€ä¸ª stMsg å¼€å¤´çš„ td
            from bs4 import BeautifulSoup
            soup = BeautifulSoup(response.text, 'html.parser')
            st_msg_td = soup.find("td", id=lambda x: x and x.startswith("stMsg"))

            if st_msg_td:
                msg_id = st_msg_td["id"].replace("stMsg", "")
                return msg_id
            else:
                update_output_text(output_text,"å¼‚å¸¸13")
                return None

        except Exception as e:
            update_output_text(output_text,f"å¼‚å¸¸14: {e}")
            return None

    def is_result_not_received(response_text):
        """
        æ£€æŸ¥å“åº”æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«â€œNot Receivedâ€å…³é”®è¯ã€‚
        """
        return "Not Received" in response_text

    # ==============================================================================
    # ä¿®æ”¹å‡½æ•° (MODIFIED FUNCTIONS)
    # ==============================================================================
    ERROR_TIMEOUT_MSG = "query è¶…æ—¶æ²¡æ‹¿åˆ°ç»“æœ"  # è¶…æ—¶å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
    PORT_MISSING_ERROR = "Port Not Found"  # æ¸¯å£ä¿¡æ¯æå–å¤±è´¥æ—¶çš„å†…éƒ¨æ ‡è®°

    def view_query_result(entry_no, query_id):
        """
        æŸ¥çœ‹æŸ¥è¯¢ç»“æœï¼Œç»Ÿè®¡ä»£ç æ•°é‡ï¼Œæå–æ¸¯å£ä¿¡æ¯ï¼Œå¹¶æ£€æŸ¥ DOCUMENT REQUIRED å…³é”®è¯ã€‚
        è¿”å›: (counts: list, manifested_port: str, actual_port: str, is_document_required: bool, response_text: str)
        """
        # 1. cookies
        cookies_dict = read_cookies_from_txt()
        if not cookies_dict:
            update_output_text(output_text,"å¼‚å¸¸15")
            return ["error"] * 8, PORT_MISSING_ERROR, PORT_MISSING_ERROR, False, ""

        # 2. transmission_id
        transmission_id = query_id
        if not transmission_id or isinstance(transmission_id, dict):
            update_output_text(output_text,"å¼‚å¸¸16")
            return ["error"] * 8, PORT_MISSING_ERROR, PORT_MISSING_ERROR, False, ""

        # 3. è¯·æ±‚
        session = requests.Session()
        for name, value in cookies_dict.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")

        headers = {
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Encoding": "gzip, deflate, br, zstd",
            "Accept-Language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7",
            "Connection": "keep-alive",
            "Host": "www.netchb.com",
            "Sec-Ch-Ua": '"Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"',
            "Sec-Ch-Ua-Mobile": "?0",
            "Sec-Ch-Ua-Platform": '"Windows"',
            "Sec-Fetch-Dest": "document",
            "Sec-Fetch-Mode": "navigate",
            "Sec-Fetch-Site": "none",
            "Sec-Fetch-User": "?1",
            "Upgrade-Insecure-Requests": "1",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
        }

        url = "https://www.netchb.com/app/transmissions/viewTransmission.do"
        payload = {"id": transmission_id}

        try:
            response = session.get(url=url, params=payload, headers=headers, timeout=30, verify=False)
            text = response.text

            if response.status_code != 200:
                update_output_text(output_text,f"å¼‚å¸¸17: {response.status_code}")
                return ["error"] * 8, PORT_MISSING_ERROR, PORT_MISSING_ERROR, False, text

            # 1. ç»Ÿè®¡ä»£ç æ•°é‡ (Count codes)
            codes = ["1H", "2H", "5H", "9H", "3H", "1A", "4A", "1Y"]
            counts = [text.count(code) for code in codes]

            # 2. æå–æ¸¯å£æ•°æ® (Extract port data)
            manifested_port_match = re.search(r'Manifested Port of Unlading/Import:\s*(\d+)', text)
            actual_port_match = re.search(r'Actual Port of Unlading/Import:\s*(\d+)', text)

            # å¦‚æœæå–å¤±è´¥ï¼Œè¿”å› PORT_MISSING_ERROR
            manifested_port = manifested_port_match.group(1).strip() if manifested_port_match else PORT_MISSING_ERROR
            actual_port = actual_port_match.group(1).strip() if actual_port_match else PORT_MISSING_ERROR

            # 3. æ£€æŸ¥ DOCUMENT REQUIRED (Check for DOCUMENT REQUIRED)
            is_document_required = "DOCUMENT REQUIRED" in text


            # æˆåŠŸè¿”å› (counts, manifested_port, actual_port, is_document_required, response_text)
            return counts, manifested_port, actual_port, is_document_required, text

        except Exception as e:
            update_output_text(output_text,f"å¼‚å¸¸18: {e}")
            # è¿”å› 8 ä¸ª error æ ‡å¿—å’Œ Port Not Found æ¸¯å£
            return ["error"] * 8, PORT_MISSING_ERROR, PORT_MISSING_ERROR, False, ""

    def get_invoice_id_from_entry(entry_no):
        """
        è·å–å‘ç¥¨ IDã€‚å‡½æ•°ä½“ä¿æŒä¸å˜ã€‚
        """
        cookies_dict = read_cookies_from_txt()
        if not cookies_dict:
            return None

        session = requests.Session()
        for name, value in cookies_dict.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")

        headers = {
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
            "Accept-Encoding": "gzip, deflate, br, zstd",
            "Accept-Language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7",
            "Connection": "keep-alive",
            "Host": "www.netchb.com",
            "Referer": "https://www.netchb.com/app/entry/processViewEntries.do",
            "Sec-Ch-Ua": '"Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"',
            "Sec-Ch-Ua-Mobile": "?0",
            "Sec-Ch-Ua-Platform": '"Windows"',
            "Sec-Fetch-Dest": "document",
            "Sec-Fetch-Mode": "navigate",
            "Sec-Fetch-Site": "same-origin",
            "Sec-Fetch-User": "?1",
            "Upgrade-Insecure-Requests": "1",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
        }

        url = f"https://www.netchb.com/app/entry/viewEntry.do?filerCode=NXU&entryNo={entry_no}"
        payload = {"filerCode": "NXU", "entryNo": entry_no}

        try:
            response = session.post(url=url, data=payload, headers=headers, timeout=30, verify=False)
            soup = BeautifulSoup(response.text, 'html.parser')

            # æ–¹æ³• 1: ä» <tr id="iRow1246024201">
            irow_tr = soup.find("tr", id=re.compile(r"^iRow\d+$"))
            if irow_tr:
                invoice_id = irow_tr["id"].replace("iRow", "")
                return invoice_id

            # æ–¹æ³• 2: ä» href="...invoiceId=1246024201..."
            a_tag = soup.find("a", href=re.compile(r"invoiceId=\d+"))

            if a_tag:
                match = re.search(r"invoiceId=(\d+)", a_tag["href"])
                if match:
                    invoice_id = match.group(1)
                    return invoice_id

            return None

        except Exception as e:
            update_output_text(output_text,f"å¼‚å¸¸19: {e}")
            return None

    def get_manufacturer_from_invoice(entry_no, invoice_id):
        """è·å–åˆ¶é€ å•†ä¿¡æ¯ã€‚å‡½æ•°ä½“ä¿æŒä¸å˜ã€‚"""
        cookies_dict = read_cookies_from_txt()
        if not cookies_dict:
            update_output_text(output_text,"å¼‚å¸¸20")
            return "error"

        if not invoice_id:
            update_output_text(output_text,"å¼‚å¸¸21")
            return "error"

        session = requests.Session()
        for name, value in cookies_dict.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")

        headers = {
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
            "Accept-Encoding": "gzip, deflate, br, zstd",
            "Accept-Language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7",
            "Connection": "keep-alive",
            "Host": "www.netchb.com",
            "Referer": f"https://www.netchb.com/app/entry/viewEntry.do?filerCode=NXU&entryNo={entry_no}",
            "Sec-Ch-Ua": '"Chromium";v="142", "Google Chrome";v="142", "Not_A Brand";v="99"',
            "Sec-Ch-Ua-Mobile": "?0",
            "Sec-Ch-Ua-Platform": '"Windows"',
            "Sec-Fetch-Dest": "document",
            "Sec-Fetch-Mode": "navigate",
            "Sec-Fetch-Site": "same-origin",
            "Sec-Fetch-User": "?1",
            "Upgrade-Insecure-Requests": "1",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
        }

        url = f"https://www.netchb.com/app/entry/invoice/editInvoice.do?method=viewInvoice&invoiceId={invoice_id}&filerCode=NXU&entryNo={entry_no}"

        payload = {
            "method": "viewInvoice",
            "invoiceId": invoice_id,
            "filerCode": "NXU",
            "entryNo": entry_no
        }

        try:
            response = session.post(url=url, data=payload, headers=headers, timeout=30, verify=False)

            soup = BeautifulSoup(response.text, 'html.parser')
            line_tr = soup.find("tr", class_="light")
            if not line_tr:
                update_output_text(output_text,"å¼‚å¸¸22")
                return "error"

            tds = line_tr.find_all("td")
            if len(tds) < 9:
                update_output_text(output_text,f"[å¼‚å¸¸23 {len(tds)}")
                return "error"

            manufacturer = tds[8].get_text(strip=True)
            return manufacturer

        except Exception as e:
            update_output_text(output_text,f"å¼‚å¸¸25 {e}")
            return "error"

    # ==============================================================================
    # ä¸»æ‰§è¡Œé€»è¾‘ (MAIN EXECUTION LOGIC)
    # ==============================================================================

    # 1. æ¨¡æ‹Ÿè¯»å– Excel æ–‡ä»¶
    try:
        df = pd.read_excel(file_path, engine='openpyxl')
        entry_nos = df.iloc[:, 0].astype(str).str.strip().tolist()
        entry_nos = [re.search(r'\d+', x).group() if '-' in x else x for x in entry_nos]
        update_output_text(output_text,f"æˆåŠŸè¯»å– {len(entry_nos)} ä¸ªå•å·ã€‚")
    except Exception as e:
        update_output_text(output_text,f"è¯»å– Excel æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        entry_nos = []

    # åˆå§‹åŒ–åˆ—è¡¨
    results = []
    pending_queries = []
    TIMEOUT_SECONDS = 10 * 60  # 10 åˆ†é’Ÿè¶…æ—¶
    RETRY_DELAY_SECONDS = 10  # 10 ç§’é‡è¯•é—´éš”

    # --- PHASE 1: QUERY SUBMISSION (æ‰¹é‡æäº¤æŸ¥è¯¢ï¼Œä¸ç­‰å¾…ç»“æœ) ---


    for entry_no in entry_nos:
        prefixed_no = f"2{entry_no}"

        try:
            # 1. é¦–æ¬¡æŸ¥è¯¢å‡†å¤‡ (Initial Query Preparation)
            cookies = read_cookies_from_txt()
            mawb_info = get_mawb_info(prefixed_no, cookies)
            payload_information_query = creat_entry_query(prefixed_no, mawb_info)
            query_result = transmit_entry_request(prefixed_no, payload_information_query)
            query_id = get_query_number(prefixed_no, query_result)

            if not query_id or query_id == "error":
                raise ValueError("æ— æ³•è·å–æœ‰æ•ˆçš„ Query ID")

            # æˆåŠŸï¼ŒåŠ å…¥ç­‰å¾…åˆ—è¡¨
            pending_queries.append({'entry_no': entry_no, 'prefixed_no': prefixed_no, 'query_id': query_id})

        except Exception as e:
            update_output_text(output_text,f"[{prefixed_no}] å¼‚å¸¸27 {e}")
            error_msg = f"æŸ¥è¯¢å‡†å¤‡å¤±è´¥: {e}"
            # è®°å½•æŸ¥è¯¢å‡†å¤‡å¤±è´¥ï¼Œä½¿ç”¨é”™è¯¯ä¿¡æ¯å¡«å……æ‰€æœ‰ç»“æœåˆ—
            # å­—æ®µé¡ºåº: entry_no + counts(8) + manifested_port + actual_port + manufacturer + status
            results.append([entry_no] + [error_msg] * 8 + [error_msg] + [error_msg] + [error_msg] + ["query å¤±è´¥"])

    # --- PHASE 2: RESULT RETRIEVAL (é€ä¸ªæŸ¥è¯¢ç»“æœï¼Œå¸¦é‡è¯•/è¶…æ—¶) ---


    for item in pending_queries:
        entry_no = item['entry_no']
        prefixed_no = item['prefixed_no']
        query_id = item['query_id']



        # å¾ªç¯é‡è¯• view_query_result (Retry loop for view_query_result)
        start_time = time.time()
        # åˆå§‹åŒ–æ‰€æœ‰ç»“æœç»„ä»¶ä¸ºè¶…æ—¶/é”™è¯¯çŠ¶æ€
        counts = [ERROR_TIMEOUT_MSG] * 8
        manifested_port = ERROR_TIMEOUT_MSG
        actual_port = ERROR_TIMEOUT_MSG
        manu = ERROR_TIMEOUT_MSG
        is_document_required = False
        query_success = False

        while time.time() - start_time < TIMEOUT_SECONDS:
            time_elapsed = int(time.time() - start_time)
            update_output_text(output_text,f"[{prefixed_no}] å°è¯•è·å–æŸ¥è¯¢ç»“æœ (å·²è€—æ—¶: {time_elapsed}s / {TIMEOUT_SECONDS}s)")

            # 2a. è·å– counts, ports, doc_required å’ŒåŸå§‹å“åº”æ–‡æœ¬
            current_counts, m_port, a_port, doc_required, response_text = view_query_result(prefixed_no, query_id)

            # 2b. æ£€æŸ¥æ˜¯å¦æˆåŠŸ
            # æˆåŠŸæ¡ä»¶ï¼šcounts ä¸­ä¸å« "error" ä¸” å“åº”æ–‡æœ¬ä¸­ä¸å« "Not Received"
            if "error" not in current_counts and not is_result_not_received(response_text):
                update_output_text(output_text,f"[{prefixed_no}] æŸ¥è¯¢ç»“æœæˆåŠŸè·å–ã€‚")

                # 2c. å­˜å‚¨æˆåŠŸè·å–çš„æ•°æ®å¹¶å°è¯•è·å– manufacturer
                counts = current_counts
                manifested_port = m_port
                actual_port = a_port
                is_document_required = doc_required

                # --- è·å– Manufacturer (ç§»åˆ°ç»“æœè·å–æˆåŠŸå) ---
                invoice_id = get_invoice_id_from_entry(prefixed_no)
                temp_manu = get_manufacturer_from_invoice(prefixed_no, invoice_id)

                if invoice_id is None:
                    manu = "N/A (æ— å‘ç¥¨ID)"
                elif temp_manu == "error":
                    manu = "Manufacturerè·å–å¤±è´¥"
                else:
                    manu = temp_manu
                # ---------------------------------------------

                query_success = True
                break
            elif "error" in current_counts:
                update_output_text(output_text,f"[{prefixed_no}] è¯·æ±‚å‡ºé”™ï¼Œç­‰å¾…é‡è¯•...")
            elif is_result_not_received(response_text):
                update_output_text(output_text,f"[{prefixed_no}] ç»“æœæœªå°±ç»ªï¼Œç­‰å¾… {RETRY_DELAY_SECONDS} ç§’åé‡è¯•...")
            else:
                update_output_text(output_text,f"[{prefixed_no}] æœªçŸ¥å¤±è´¥ï¼Œç­‰å¾… {RETRY_DELAY_SECONDS} ç§’åé‡è¯•...")

            # 2d. ç­‰å¾…é‡è¯•
            time.sleep(RETRY_DELAY_SECONDS)

        # 3. è®¡ç®—æœ€ç»ˆçŠ¶æ€ (Calculate final status)
        if not query_success:
            update_output_text(output_text,f"[{prefixed_no}] è¾¾åˆ° {TIMEOUT_SECONDS} ç§’è¶…æ—¶ï¼Œæœªèƒ½è·å–æœ€ç»ˆç»“æœã€‚")
            final_status = "query å¤±è´¥"
        else:
            # æ£€æŸ¥æ¸¯å£ä¿¡æ¯æå–æ˜¯å¦å¤±è´¥ï¼ˆæ»¡è¶³ç”¨æˆ·æ–°å¢è¦æ±‚ï¼‰
            if manifested_port == PORT_MISSING_ERROR:
                final_status = "query å¤±è´¥"
                update_output_text(output_text,f"[{prefixed_no}] æ¸¯å£ä¿¡æ¯æå–å¤±è´¥ï¼ˆManifested Port æˆ– Actual Port ç¼ºå¤±ï¼‰ï¼ŒçŠ¶æ€è®¾ç½®ä¸º 'query å¤±è´¥'ã€‚")
                # ç¡®ä¿ port åˆ—çš„æ•°æ®è¢«è®°å½•ä¸º 'æå–å¤±è´¥'
                if manifested_port == PORT_MISSING_ERROR: manifested_port = "æå–å¤±è´¥"
                if actual_port == PORT_MISSING_ERROR: actual_port = "æå–å¤±è´¥"

            # 4. æ ¹æ®æˆåŠŸè·å–çš„æ•°æ®è®¡ç®—æœ€ç»ˆçŠ¶æ€ï¼Œæ’é™¤ 1Y çš„å…¶ä»–æ•°é‡ (0-6 ç´¢å¼•)
            elif manifested_port != actual_port and actual_port != PORT_MISSING_ERROR:
                final_status = "port ä¸åŒ"
            # æ£€æŸ¥ 1H, 2H, 5H, 9H, 3H, 1A, 4A ä¸­æ˜¯å¦æœ‰éé›¶æ•°é‡ï¼Œæˆ–æ˜¯å¦æœ‰ DOCUMENT REQUIRED å…³é”®è¯
            else:
                # æ£€æŸ¥æ˜¯å¦ä¸º int ç±»å‹ï¼Œé¿å… 'error' å‚ä¸æ¯”è¾ƒ
                check_counts = [c for c in counts[:7] if isinstance(c, int) and c >= 0]
                if any(c > 0 for c in check_counts) or is_document_required:
                    final_status = "æœ‰æ‰£è´§"
                else:
                    final_status = "Y"

        # 5. è®°å½•æœ€ç»ˆç»“æœ
        # ç»“æœè¡Œï¼šentry_no + counts (8) + manifested_port (1) + actual_port (1) + manu (1) + final_status (1)
        result_row = [entry_no] + counts + [manifested_port] + [actual_port] + [manu] + [final_status]
        results.append(result_row)

    # 3. å†™ Excel (Write to Excel)
    # æ–°çš„åˆ—é¡ºåºå’Œåç§°ï¼š
    COLUMNS = [
        "entry_no", "1H", "2H", "5H", "9H", "3H", "1A", "4A", "1Y",
        "Manifested Port", "Actual Port", "manufacturer", "status"
    ]
    df_result = pd.DataFrame(results, columns=COLUMNS)

    # å†™å…¥ Excel
    try:
        df_result.to_excel(file_path, index=False)
        update_output_text(output_text,f"\nå¤„ç†å®Œæˆï¼ç»“æœå·²ä¿å­˜ï¼š{file_path}")
    except Exception as e:
        update_output_text(output_text,f"\nå†™å…¥ Excel æ–‡ä»¶å¤±è´¥: {e}")
    update_output_text(output_text,"ç¨‹åºå®Œæˆ")
def netchb_entry_update(account, password, output_text):
    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "yuejie.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text,"å·²æ‰¾åˆ°éœ€è¦çš„excelï¼Œæ­£åœ¨ç»§ç»­ä»£ç \n")
            pass
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            update_output_text(output_text, "å·²æ‰¾åˆ°excel æ­£åœ¨ç»§ç»­ä»£ç \n")

            wb = Workbook()
            wb.save(file_path)
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://www.netchb.com/app/entry/"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])


    # # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="lName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="pass"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.XPATH,
                                       "/html/body/div[2]/div[3]/div/main/div/div/div/article/div/div/form/div[2]/input")
    login_button.click()
    initial_title = driver.title
    initial_url = driver.current_url
    url = "https://www.netchb.com/app/entry/"
    driver.get(url)

    def read_cookies_from_txt():
        txt_file_path = os.path.join(desktop_path, "yuejie.txt")

        if not os.path.exists(txt_file_path):
            update_output_text(output_text,"output.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼\n")
            return {}

        try:
            with open(txt_file_path, 'r', encoding='utf-8') as txt_file:
                data = json.load(txt_file)

            raw_cookies = data.get("cookies", {})
            if not isinstance(raw_cookies, dict):
                update_output_text(output_text,"å¼‚å¸¸1")
                return {}

            cookies_dict = {}
            for name, info in raw_cookies.items():
                if isinstance(info, dict) and 'value' in info:
                    cookies_dict[name] = info['value']
                else:
                    cookies_dict[name] = str(info)

            return cookies_dict

        except json.JSONDecodeError as je:
            update_output_text(output_text,f"ç½‘é¡µè§£æå¤±è´¥ï¼é”™è¯¯: {je}")
            return {}
        except Exception as e:
            update_output_text(output_text,f"è¯»å–æ–‡æœ¬æ–‡ä»¶å‡ºé”™: {type(e).__name__}: {e}")
            return {}

    def get_mawb_info(entry_no, cookies, result_dict):
        """
        æ ¹æ® Entry No æŠ“å– 7501 å’Œ 3461 çš„çŠ¶æ€ã€‚
        é‡‡ç”¨åŸºäºä½ç½®çš„ç¨³å®šæŠ“å–ç­–ç•¥ã€‚
        """
        session = requests.Session()

        # å¼ºåˆ¶è®¾ç½® cookieï¼ˆä¸¤ä¸ªåŸŸåéƒ½è®¾ä¸€éï¼Œä¿é™©ï¼‰
        for name, value in cookies.items():
            session.cookies.set(name, value, domain="www.netchb.com", path="/")
            session.cookies.set(name, value, domain=".netchb.com", path="/")

        headers = {
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Encoding": "gzip, deflate, br, zstd",
            "Accept-Language": "zh-CN,zh;q=0.9",
            "Cache-Control": "max-age=0",
            "Connection": "keep-alive",
            "Content-Type": "application/x-www-form-urlencoded",
            "Origin": "https://www.netchb.com",
            "Referer": "https://www.netchb.com/app/entry/processViewEntries.do",
            "Upgrade-Insecure-Requests": "1",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36",
        }

        # æ³¨æ„ï¼šEntry No æœç´¢æ—¶å¯èƒ½éœ€è¦ Entry No å…¨ç§° (e.g., NXU-9996397-5)
        # å‡è®¾ entry_no å·²ç»æ˜¯å®Œæ•´çš„ Entry No å­—ç¬¦ä¸²
        payload = {
            "entryNoSearch": str(entry_no),
            "searchTimePeriod": "Y1",
            "user": "NXUAUTO",
            "location": "4755",  # å‡è®¾è¿™æ˜¯ä¸€ä¸ªé€šç”¨æˆ–é»˜è®¤å€¼
            "noPerPage": "50",
            "orderBy": "vep1",
            "page": "0",
            "method": "view"
        }

        try:
            resp = session.post(
                "https://www.netchb.com/app/entry/processViewEntries.do",
                data=payload, headers=headers, timeout=30, verify=False
            )
        except Exception as e:
            result_dict[entry_no] = {"7501": "NET_ERR", "3461": "NET_ERR"}
            print(f"[{entry_no}] ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
            return

        if resp.status_code != 200 or "login" in resp.text.lower():
            result_dict[entry_no] = {"7501": "LOGIN", "3461": "LOGIN"}
            print(f"[{entry_no}] ç™»å½•çŠ¶æ€å¼‚å¸¸æˆ–è¿”å›ç é 200")
            return

        # ====================== 1. æ­£åˆ™ç›´æ¥æš´åŠ›æŠ ï¼ˆæœ€ç¨³ä¸”æœ€å¿«ï¼‰ ======================
        text = resp.text
        # æ‰“å°è¿”å›çš„ HTML ä¾›è°ƒè¯•
        # print(text)

        # ğŸ“Œ æ­£åˆ™ç­–ç•¥ï¼šå®šä½ Entry No é“¾æ¥ï¼Œè·³è¿‡åç»­ 7 ä¸ª <td>ï¼Œç„¶åæ•è·æ¥ä¸‹æ¥çš„ 2 ä¸ª <td>
        # 1. åŒ¹é… Entry No çš„ <a> é“¾æ¥
        # 2. åŒ¹é…å¹¶è·³è¿‡ Entry No <td> çš„ç»“æŸæ ‡ç­¾ </td>
        # 3. åŒ¹é…å¹¶è·³è¿‡æ¥ä¸‹æ¥çš„ 7 ä¸ª <td>/</td> å¯¹ (Importer åˆ° ETA)
        # 4. æ•è·ç¬¬ 9 ä¸ª <td> çš„å†…å®¹ (7501 Status)
        # 5. æ•è·ç¬¬ 10 ä¸ª <td> çš„å†…å®¹ (3461 Status)

        # å› ä¸º Entry No (e.g., NXU-9996397-5) åŒ…å«è¿å­—ç¬¦ï¼Œè¿™é‡Œç®€åŒ–ä¸ºåªåŒ¹é…æ•°å­—éƒ¨åˆ†
        # å‡è®¾ entryNo æ˜¯å®Œæ•´çš„ Entry No å­—ç¬¦ä¸²
        entry_link_part = re.escape(str(entry_no))

        # ä½¿ç”¨ (\s*<td[^>]*>.*?</td>){7} æ¥è·³è¿‡ 7 ä¸ªå­—æ®µï¼Œå¹¶ä½¿ç”¨éè´ªå©ªåŒ¹é… .*?
        pattern = rf'<a href="/app/entry/viewEntry\.do\?filerCode=.*?&amp;entryNo={entry_link_part}">.*?</a>\s*</td>'  # åŒ¹é…åˆ° Entry No <td> ç»“æŸ
        pattern += r'(\s*<td[^>]*>.*?</td>){7}'  # è·³è¿‡ Importer åˆ° ETA çš„ 7 ä¸ª <td>
        pattern += r'\s*<td[^>]*>([^<]+)</td>'  # æ•è·ç¬¬ 9 ä¸ª <td> (7501 Status)
        pattern += r'\s*<td[^>]*>([^<]+)</td>'  # æ•è·ç¬¬ 10 ä¸ª <td> (3461 Status)

        match = re.search(pattern, text, re.DOTALL | re.IGNORECASE)

        if match:
            # group(1) æ˜¯è·³è¿‡çš„ 7 ä¸ª <td> çš„æœ€åä¸€ä¸ªï¼Œæˆ‘ä»¬ä¸éœ€è¦ã€‚
            # group(2) æ˜¯ 7501 çŠ¶æ€
            # group(3) æ˜¯ 3461 çŠ¶æ€
            status_7501 = match.group(2).strip()
            status_3461 = match.group(3).strip()
            result_dict[entry_no] = {"7501": status_7501, "3461": status_3461}
            print(f"[{entry_no}] â†’ æˆåŠŸï¼ˆæ­£åˆ™-ä½ç½®ï¼‰ â†’ 7501: {status_7501} | 3461: {status_3461}")
            return

        # ====================== 2. BS4 å¤‡ç”¨æ–¹æ¡ˆï¼ˆåŸºäºä½ç½®ï¼‰ ======================
        soup = BeautifulSoup(text, "html.parser")

        # ğŸ“Œ BS4 ç­–ç•¥ï¼šæ‰¾åˆ° Entry No é“¾æ¥ï¼Œæ‰¾åˆ°çˆ¶çº§è¡Œï¼Œç„¶åæŒ‰ç´¢å¼•å–ç¬¬ 8 å’Œ 9 ä¸ª <td> (ä» 0 å¼€å§‹)
        # æ ¹æ®æ‚¨æä¾›çš„ HTMLï¼ŒEntry No åœ¨ <a> æ ‡ç­¾ä¸­ï¼Œé€šè¿‡ href å±æ€§å®šä½ã€‚
        a_tag = soup.find("a", href=lambda href: href and str(entry_link_part) in href)

        if a_tag:
            tr = a_tag.find_parent("tr")
            if tr:
                # æ‰¾åˆ°<tr>ä¸‹çš„æ‰€æœ‰<td>æ ‡ç­¾
                all_tds = tr.find_all("td")

                # Entry No æ˜¯ç¬¬ 1 åˆ— (ç´¢å¼• 0)ï¼Œ7501 Status æ˜¯ç¬¬ 9 åˆ— (ç´¢å¼• 8)ï¼Œ3461 Status æ˜¯ç¬¬ 10 åˆ— (ç´¢å¼• 9)

                if len(all_tds) >= 10:  # ç¡®ä¿è‡³å°‘æœ‰ 10 ä¸ª td
                    # ç´¢å¼• 8: 7501 Status
                    status_7501 = all_tds[8].get_text(strip=True)
                    # ç´¢å¼• 9: 3461 Status
                    status_3461 = all_tds[9].get_text(strip=True)

                    result_dict[entry_no] = {
                        "7501": status_7501,
                        "3461": status_3461
                    }
                    print(f"[{entry_no}] â†’ æˆåŠŸï¼ˆBS4-ä½ç½®ï¼‰ â†’ 7501: {status_7501} | 3461: {status_3461}")
                    return

        # ====================== 3. å¤±è´¥å¤„ç† ======================
        result_dict[entry_no] = {"7501": "æœªæå–åˆ°", "3461": "æœªæå–åˆ°"}
        print(f"\nã€{entry_no} æŠ“å–å¤±è´¥ã€‘è¯·æ£€æŸ¥ Entry No æ˜¯å¦æ­£ç¡®æˆ–é¡µé¢ç»“æ„æ˜¯å¦æ”¹å˜ã€‚")


    def wait_and_click(driver, xpath, timeout=3, interval=0.5):
        """
        å°è¯• timeout ç§’ï¼Œæ¯ interval ç§’æ£€æŸ¥å…ƒç´ æ˜¯å¦å‡ºç°å¹¶ç‚¹å‡»
        è¿”å› Trueï¼ˆç‚¹å‡»æˆåŠŸï¼‰æˆ– Falseï¼ˆè¶…æ—¶æœªç‚¹å‡»ï¼‰
        """
        end_time = time.time() + timeout

        while time.time() < end_time:
            try:
                element = driver.find_element(By.XPATH, xpath)
                element.click()
                return True
            except:
                time.sleep(interval)
        return False

    df = pd.read_excel(file_path, engine='openpyxl', dtype=str)  # â† æ”¹è¿™é‡Œï¼ŒåŠ  dtype=str é˜²æ­¢æ•°å­—å˜ç§‘å­¦è®¡æ•°

    # 2. è¿‡æ»¤å®Œåï¼ŒæŠŠåŸå§‹è¡Œç´¢å¼•ä¿å­˜ä¸‹æ¥ï¼ˆåŠ åœ¨è¿™ä¸¤è¡Œä¸‹é¢å°±è¡Œï¼‰
    df_filtered = df[df.iloc[:, 12].astype(str).str.strip() == 'Y']
    original_indices = df_filtered.index.tolist()  # â† æ–°å¢è¿™è¡Œ# è¿‡æ»¤ç¬¬ååˆ—ä¸º 'Y' çš„è¡Œ

    # æå–ç¬¬ä¸€åˆ—ï¼ˆentry_nosï¼‰
    entry_nos = df_filtered.iloc[:, 0].astype(str).str.strip().tolist()
    entry_nos = [re.search(r'\d+', x).group() if '-' in x else x for x in entry_nos]
    # æå–ç¬¬ååˆ—ï¼ˆmanufacture_listï¼‰ï¼Œæ³¨æ„è¿™é‡Œéƒ½æ˜¯ 'Y'
    manufacture_list = df_filtered.iloc[:, 11].astype(str).str.strip().tolist()
    # 2. å¤„ç†æ¯ä¸ªå•å·ï¼ˆåœ¨å•å·å‰åŠ  2ï¼‰
    update_output_text(output_text,f'entryéƒ½æœ‰:{entry_nos}')

    def main_function(entry_no, manufacture):
        prefixed_no = f"2{entry_no}"  # <--- è¿™é‡Œåœ¨å‰é¢åŠ  2
        driver.get(f'https://www.netchb.com/app/entry/isf.do?filerCode=NXU&entryNo={prefixed_no}')
        mf_input = WebDriverWait(driver, 10).until(
            EC.visibility_of_element_located((By.XPATH, '//*[@id="sMd0"]'))
        )
        mf_input.clear()
        mf_input.send_keys(manufacture)
        click = wait_and_click(driver, '//*[@id="mfcCRow0"]')
        option = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, "#cfrm1 option[value='consignee']"))
        )
        # é€‰ä¸­ consignee
        select_element = driver.find_element(By.ID, "cfrm1")
        select = Select(select_element)
        select.select_by_value("consignee")
        time.sleep(2)
        save_button = driver.find_element(By.XPATH,
                                          '//*[@id="entF"]/div[11]/input[1]')
        save_button.click()

        driver.get(f'https://www.netchb.com/app/entry/transmit/finalizeEntry.do?filerCode=NXU&entryNo={prefixed_no}')
        transmit_button = driver.find_element(By.XPATH,
                                              '//*[@id="t0"]/input[1]')


        transmit_button.click()




    result_dict = {}
    # for idx, entry_no, manufacture in zip(original_indices, entry_nos, manufacture_list):
    if '7501_status' not in df.columns:
        df['7501_status'] = ''  # ç”¨æ¥æ”¾ 7501 çŠ¶æ€ï¼ˆä¼šå‡ºç°åœ¨ç¬¬ 15 åˆ—æˆ–ä½ æƒ³è¦çš„ä½ç½®ï¼‰
    if '3461_status' not in df.columns:
        df['3461_status'] = ''  # ç”¨æ¥æ”¾ 3461 çŠ¶æ€

    for idx, entry_no, manufacture in zip(original_indices, entry_nos, manufacture_list):
        success = False
        for attempt in range(2):
            try:
                main_function(entry_no, manufacture)
                update_output_text(output_text, f"{entry_no} å¤„ç†æˆåŠŸ")
                success = True
                break  # æˆåŠŸå°±è·³å‡ºé‡è¯•å¾ªç¯
            except Exception as e:
                if attempt == 0:
                    update_output_text(output_text, f"{entry_no} ç¬¬1æ¬¡å¤±è´¥: {e}ï¼Œ1ç§’åé‡è¯•...")
                    time.sleep(1)
                else:
                    update_output_text(output_text, f"{entry_no} ç¬¬2æ¬¡ä¹Ÿå¤±è´¥ï¼Œæ ‡è®°ä¸ºå¤±è´¥")
                    df.loc[idx, df.columns[13]] = "æ¸…å…³å¤±è´¥"  # ç¬¬14åˆ—ï¼ˆNåˆ—ï¼‰æ ‡è®°å¤±è´¥
                    success = False

        # å¦‚æœä¸¤æ¬¡éƒ½å¤±è´¥ï¼Œä¹Ÿè¦ä¿è¯æœ‰æ ‡è®°ï¼ˆä¸Šé¢çš„ else å·²ç»å†™äº†ï¼Œè¿™é‡Œå†ä¿ä¸€æ¬¡ï¼‰
        if not success:
            df.loc[idx, df.columns[13]] = "æ¸…å…³å¤±è´¥"

        # ------------------- å‰é¢ Selenium éƒ¨åˆ†ç»“æŸï¼Œç­‰ 2 ç§’å†å»æŸ¥çŠ¶æ€ -------------------
        driver.get('https://www.netchb.com/app/entry/index.jsp')
        time.sleep(2)

        # ------------------- è¯»å– cookies å¹¶æŠ“å– 7501 / 3461 çŠ¶æ€ -------------------
        cookies = read_cookies_from_txt()
        get_mawb_info(entry_no, cookies, result_dict)

        # ------------------- æŠŠæŠ“åˆ°çš„çŠ¶æ€å†™å› Excel ç¬¬15ã€16åˆ— -------------------
        if entry_no in result_dict:
            st = result_dict[entry_no]
            df.loc[idx, '7501_status'] = st.get("7501", "N/A")  # ç¬¬15åˆ—ï¼ˆOåˆ—ï¼‰
            df.loc[idx, '3461_status'] = st.get("3461", "N/A")  # ç¬¬16åˆ—ï¼ˆPåˆ—ï¼‰
        else:
            df.loc[idx, '7501_status'] = "æŸ¥è¯¢å¤±è´¥"
            df.loc[idx, '3461_status'] = "æŸ¥è¯¢å¤±è´¥"

    # ------------------- å…¨éƒ¨å¤„ç†å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä¿å­˜ Excel -------------------
    df.to_excel(file_path, index=False, engine='openpyxl')
    update_output_text(output_text, "å¤„ç†å®Œæ¯•ï¼\n")



import customtkinter as ctk
from tkinter import messagebox
import threading

ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("blue")

# ç”¨äºåœæ­¢çº¿ç¨‹çš„äº‹ä»¶
stop_event = threading.Event()


def start_program(account, password, output_text, task_type, mode=None):
    stop_event.clear()  # æ¸…é™¤åœæ­¢äº‹ä»¶ï¼Œå‡†å¤‡å¼€å§‹ä»»åŠ¡

    if task_type == "netchb larryæœåŠ¡å™¨é“¾æ¥ï¼ˆ4å°æ—¶ä¸€æ¬¡ï¼‰":
        netchb_token(account, password, output_text)
    elif task_type == "queryç›®æ ‡å•å·":
        netchb_query(account, password, output_text)
    elif task_type == "netchbä¸Šä¼ ":
        netchb_entry_update(account, password, output_text)
    # ç™»å½•ç•Œé¢


def login_window():
    global windowname
    windowname = 'login'

    login_frame = ctk.CTkFrame(root, fg_color="#1e1e1e", corner_radius=20)
    login_frame.pack(padx=20, pady=20, fill="both", expand=True)

    def proceed_login():
        account = entry_account.get()
        password = entry_password.get()
        if not account or not password:
            messagebox.showerror("é”™è¯¯", "è´¦å·æˆ–å¯†ç ä¸èƒ½ä¸ºç©ºï¼")
            return
        login_frame.destroy()
        show_main_window(account, password)

    label_account = ctk.CTkLabel(login_frame, text="è´¦å·:", font=("Arial", 16), text_color="#FFFFFF")
    label_account.pack(pady=10)
    entry_account = ctk.CTkEntry(login_frame, width=300, height=35, font=("Arial", 12), placeholder_text="è¯·è¾“å…¥è´¦å·")
    entry_account.pack(pady=10)

    label_password = ctk.CTkLabel(login_frame, text="å¯†ç :", font=("Arial", 16), text_color="#FFFFFF")
    label_password.pack(pady=10)
    entry_password = ctk.CTkEntry(login_frame, width=300, height=35, show="*", font=("Arial", 12),
                                  placeholder_text="è¯·è¾“å…¥å¯†ç ")
    entry_password.pack(pady=10)

    login_button = ctk.CTkButton(login_frame, text="ç¡®è®¤", command=proceed_login, width=200, height=40,
                                 corner_radius=10)
    login_button.pack(pady=20)


# ä¸»ç•Œé¢
def show_main_window(account, password):
    global windowname
    main_frame = ctk.CTkFrame(root, fg_color="#1e1e1e", corner_radius=20)
    main_frame.pack(padx=20, pady=20, fill="both", expand=True)

    def switch_to_task(task_type):
        global windowname
        main_frame.destroy()
        show_task_window(account, password, task_type)
        windowname = 'task'

    def create_button(parent, text, command=None):
        return ctk.CTkButton(
            parent,
            text=text,
            command=command,
            width=150,
            height=150,
            corner_radius=0,
            font=("Arial", 14),
            fg_color="#2e2e2e",
            border_color="#1f6aa5",
            border_width=2,
            hover_color="#3a3a3a",
        )

    scrollable_frame = ctk.CTkScrollableFrame(main_frame, fg_color="transparent", width=540, height=260)
    scrollable_frame.pack(pady=20, padx=10, fill="both", expand=True)

    buttons = [

                  ("æœåŠ¡å™¨é“¾æ¥", lambda: switch_to_task("netchb larryæœåŠ¡å™¨é“¾æ¥ï¼ˆ4å°æ—¶ä¸€æ¬¡ï¼‰")),
                  ("queryç›®æ ‡å•å·", lambda: switch_to_task("queryç›®æ ‡å•å·")),
                  ("netchbä¸Šä¼ ", lambda: switch_to_task("netchbä¸Šä¼ ")),



              ] + [("æœªè§£é”åŠŸèƒ½", None)] * 16  # å¢åŠ ç‚¹æŒ‰é’®ä»¥ä¾¿æ˜¾ç¤ºæ»šåŠ¨æ•ˆæœ

    def create_button(parent, text, command=None):
        return ctk.CTkButton(
            parent,
            text=text,
            command=command,
            width=150,
            height=150,
            corner_radius=0,
            font=("Arial", 14),
            fg_color="#2e2e2e",
            border_color="#1f6aa5",
            border_width=2,
            hover_color="#3a3a3a",
        )

    for i in range(9):  # è¡Œ
        for j in range(3):  # åˆ—
            idx = i * 3 + j
            if idx < len(buttons):
                btn_text, btn_cmd = buttons[idx]
                btn = btn = create_button(scrollable_frame, btn_text, btn_cmd)
                btn.grid(row=i, column=j, padx=10, pady=10)


# ä»»åŠ¡ç•Œé¢
def show_task_window(account, password, task_type):
    task_frame = ctk.CTkFrame(root, fg_color="#1e1e1e", corner_radius=20)
    task_frame.pack(padx=20, pady=20, fill="both", expand=True)

    output_text = ctk.CTkTextbox(
        task_frame, width=520, height=120, font=("Consolas", 11),
        fg_color="#1e1e1e", text_color="#FFFFFF", corner_radius=10,
        border_width=2, border_color="#007acc"
    )
    output_text.pack(pady=10)

    if task_type == "Hold" or task_type == "headerä¿®æ”¹":
        mode_var = ctk.StringVar()

        mode_label = ctk.CTkLabel(task_frame, text="è¯·é€‰æ‹©æ“ä½œæ¨¡å¼ï¼š", text_color="white")
        mode_label.pack()

        if task_type == "Hold":
            mode_var.set("ä»…æŸ¥æ‰¾")
            mode_dropdown = ctk.CTkOptionMenu(
                task_frame,
                variable=mode_var,
                values=["ä»…æŸ¥æ‰¾", "åˆ é™¤"],
                width=120
            )
        elif task_type == "headerä¿®æ”¹":
            mode_var.set("61")
            mode_dropdown = ctk.CTkOptionMenu(
                task_frame,
                variable=mode_var,
                values=["61", "63"],
                width=120
            )


        mode_dropdown.pack(pady=5)
    if task_type == "æ¢¦æƒ³æˆçœŸæ¨¡æ‹Ÿå™¨":
        output_text.destroy()
        title_frame = ctk.CTkFrame(task_frame, fg_color="transparent")
        title_frame.pack(pady=30)

        dream_label1 = ctk.CTkLabel(title_frame, text="æ¢¦", text_color="#FF69B4",
                                    font=("Comic Sans MS", 28, "bold"))
        dream_label1.pack(side="left")
        dream_label2 = ctk.CTkLabel(title_frame, text="æƒ³", text_color="#00BFFF",
                                    font=("Comic Sans MS", 28, "bold"))
        dream_label2.pack(side="left")
        rest_label = ctk.CTkLabel(title_frame, text="æˆçœŸæ¨¡æ‹Ÿå™¨", text_color="#FFFFFF",
                                  font=("Comic Sans MS", 26, "bold"))
        rest_label.pack(side="left")

        def transform_dreams():
            progress_win = Toplevel(root)
            progress_win.title("æ¢¦æƒ³æˆçœŸä¸­")
            progress_win.geometry("400x150")
            progress_win.configure(bg="white")

            label = tk.Label(progress_win, text="æ¢¦æƒ³æˆçœŸä¸­...", font=("Arial", 14), bg="white")
            label.pack(pady=10)

            progress_bar = ttk.Progressbar(progress_win, length=300, mode='determinate')
            progress_bar.pack(pady=10)
            progress_bar["value"] = 0

            def update_bar():
                for i in range(101):
                    progress_bar["value"] = i
                    label.config(text=f"æ¢¦æƒ³æˆçœŸä¸­... {i}%")
                    time.sleep(0.05)
                    progress_win.update_idletasks()

                label.config(text="ğŸ‰ æ¢¦æƒ³å·²æˆçœŸ ğŸ‰")

                # âœ… è¾¾åˆ° 100% æ—¶ç«‹å³æ›¿æ¢æ–‡å­—
                def replace_text(widget):
                    try:
                        if hasattr(widget, "cget") and callable(widget.cget):
                            if "text" in widget.keys():
                                text = widget.cget("text")
                                if text:
                                    new_text = text.replace("æ¢¦æƒ³", "çœŸçš„").replace("æ¢¦", "çœŸ").replace("æƒ³", "çš„")
                                    widget.configure(text=new_text)
                    except:
                        pass
                    for child in widget.winfo_children():
                        replace_text(child)

                replace_text(task_frame)

                # âœ… è‡ªåŠ¨ 1 ç§’åå…³é—­è¿›åº¦çª—å£
                time.sleep(1)
                progress_win.destroy()

            threading.Thread(target=update_bar, daemon=True).start()

        dream_button = ctk.CTkButton(
            task_frame,
            text="ç‚¹å‡»æŠŠæ¢¦æƒ³å˜æˆçœŸçš„",
            command=transform_dreams,
            width=250,
            height=60,
            corner_radius=15,
            font=("Comic Sans MS", 18, "bold"),
            fg_color="#FF69B4",
            hover_color="#FF1493"
        )
        dream_button.pack(pady=40)

        back_button = ctk.CTkButton(task_frame, text="è¿”å›",
                                    command=lambda: go_back_to_main(task_frame, account, password),
                                    width=200, height=40, corner_radius=10)
        back_button.pack(pady=20)

        return  # ä¸ç»§ç»­æ‰§è¡Œä¸‹é¢çš„é€šç”¨é€»è¾‘

    def start_task():
        output_text.insert("end", f"å¯åŠ¨ {task_type} ä»»åŠ¡...\n")
        if task_type == "Hold" or task_type == "headerä¿®æ”¹":
            mode = mode_var.get()
            threading.Thread(target=start_program, args=(account, password, output_text, task_type, mode),
                             daemon=True).start()
        else:
            threading.Thread(target=start_program, args=(account, password, output_text, task_type),
                             daemon=True).start()

    start_button = ctk.CTkButton(task_frame, text="å¼€å§‹ä»»åŠ¡", command=start_task)
    start_button.pack(pady=10)

    back_button = ctk.CTkButton(task_frame, text="è¿”å›", command=lambda: go_back_to_main(task_frame, account, password),
                                width=200, height=40, corner_radius=10)
    back_button.pack(pady=20)


# è¿”å›ä¸»ç•Œé¢å¹¶åœæ­¢ä»»åŠ¡
def go_back_to_main(current_frame, account, password):
    global windowname
    print("é”€æ¯å½“å‰çª—å£...")  # è°ƒè¯•æ‰“å°
    current_frame.destroy()
    stop_event.set()  # è®¾ç½®åœæ­¢äº‹ä»¶ï¼Œé€šçŸ¥å­çº¿ç¨‹é€€å‡º
    show_main_window(account, password)
    windowname = 'main'


# åˆå§‹åŒ–ä¸»çª—å£
root = ctk.CTk()
root.title("çœŸæ˜¯ä¸€å¯¹è‹¦å‘½é¸³é¸¯")
root.geometry("600x420")
root.configure(fg_color="#1e1e1e")

# æ˜¾ç¤ºç™»å½•çª—å£
login_window()

# å¯åŠ¨ GUI ä¸»å¾ªç¯
root.mainloop()
